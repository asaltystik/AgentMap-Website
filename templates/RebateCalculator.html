<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home Health Care Rebate Calculator</title>
</head>
<body>
    <div class="logout-container">
        {{ user.first_name }} {{ user.last_name }}
        <form id="logout-form" class="logout-button-form" action="{% url 'Logout' %}"
              method="POST" hx-trigger="click" title="Sign Out">
            {% csrf_token %}
            <button type="submit" class="logout-button preload" title="Sign Out">
                <!-- Logout icon from hugeicons.com -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                     color="#000000" fill="none">
                    <path d="M11 3L10.3374 3.23384C7.75867 4.144 6.46928 4.59908 5.73464 5.63742C5 6.67576 5 8.0431 5 10.7778V13.2222C5 15.9569 5 17.3242 5.73464 18.3626C6.46928 19.4009 7.75867 19.856 10.3374 20.7662L11 21"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    <path d="M21 12L11 12M21 12C21 11.2998 19.0057 9.99153 18.5 9.5M21 12C21 12.7002 19.0057 14.0085 18.5 14.5"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                          stroke-linejoin="round"></path>
                </svg>
            </button>
        </form>
    </div>
    <h2 style="margin-top: 1px; margin-bottom: 1px;">Home Health Care Drug Fill Rebate</h2>
    <div class="rebate-container">
        <form id="rebate-form" class="rebate-form" action="{% url 'RebateCalculator' %}" method="POST">
            {% csrf_token %}
            <div class="rebate-table-container" style="max-height: 25vh; overflow-y: auto">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Drug Name</th>
                            <th>Drug Type</th>
                            <th>Fills/Year</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="rebate-form-body">
                        <tr class="rebate-form-row">
                            <td>1</td>
                            <td>
                                <input type="text" id="drug-name-1" name="drug-name">
                            </td>
                            <td>
                                <input type="checkbox" id="branded-1" name="drug-type" value="branded" onclick="toggleCheckbox(this)">
                                <label for="branded-1">Branded</label>
                                <input type="checkbox" id="generic-1" name="drug-type" value="generic" onclick="toggleCheckbox(this)">
                                <label for="generic-1">Generic</label>
                            </td>
                            <td>
                                <input type="number" id="fills-year-1" name="fills-per-year" style="width: 4vw" required>
                                <label for="fills-month-1" class="hidden"></label>
                            </td>
                            <td>
                                <button type="button" onclick="removeRow(this)">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="rebate-form-button" onclick="addRow()">Add Row</button>
            <!-- make the submit button doesnt load a new page, should just update teh info-box -->
            <button type="button" class="rebate-form-button" onclick="updateCalculations()">Calculate Rebate</button>
        </form>
    </div>
    <div class="results-container" style="overflow-y: auto">
        <h2 style="margin: 0 0 0 0;">Rebate Results</h2>
        <table>
            <thead>
                <tr>
                    <th>Carrier</th>
                    <th>Bronze</th>
                    <th>Silver</th>
                    <th>Gold</th>
                    <th>Select Plan</th>
                    <th>Monthly Rate</th>
                    <th>Updated Calculation</th>
                </tr>
            </thead>
            <tbody id="rebate-results-body">
                {% if results %}
                    {% for result in results %}
                        <tr>
                            <td>{{ result.carrier }}</td>
                            <td>{{ result.bronze }}</td>
                            <td>{{ result.silver }}</td>
                            <td>{{ result.gold }}</td>
                            <td>
                                <input type="radio" name="plan-{{ forloop.counter }}" value="bronze" onchange="updateRowCalculation({{ forloop.counter }})"> Bronze
                                <input type="radio" name="plan-{{ forloop.counter }}" value="silver" onchange="updateRowCalculation({{ forloop.counter }})"> Silver
                                <input type="radio" name="plan-{{ forloop.counter }}" value="gold" onchange="updateRowCalculation({{ forloop.counter }})"> Gold
                            </td>
                            <td>
                                <input type="number" name="monthly-rate-{{ forloop.counter }}" required onchange="updateRowCalculation({{ forloop.counter }})">
                            </td>
                            <td id="updated-calculation-{{ forloop.counter }}"></td>
                        </tr>
                    {% endfor %}
                {% else %}
                {% endif %}
                    <tr>
                        <td colspan="7">No results available</td>
                    </tr>
            </tbody>
        </table>
    </div>
    <!-- Existing HTML content -->
<script>
    // Existing JavaScript content

    function updateCalculations() {
        const form = document.getElementById('rebate-form');
        const formData = new FormData(form);

        fetch('{% url "RebateCalculator" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            const resultsBody = document.getElementById('rebate-results-body');
            resultsBody.innerHTML = ''; // Clear existing results

            data.results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.carrier}</td>
                    <td>${result.bronze}</td>
                    <td>${result.silver}</td>
                    <td>${result.gold}</td>
                    <td>
                        <input type="radio" name="plan-${index + 1}" value="bronze" onchange="updateRowCalculation(${index + 1})"> Bronze
                        <input type="radio" name="plan-${index + 1}" value="silver" onchange="updateRowCalculation(${index + 1})"> Silver
                        <input type="radio" name="plan-${index + 1}" value="gold" onchange="updateRowCalculation(${index + 1})"> Gold
                    </td>
                    <td>
                        <input type="number" name="monthly-rate-${index + 1}" required onchange="updateRowCalculation(${index + 1})">
                    </td>
                    <td id="updated-calculation-${index + 1}"></td>
                `;
                resultsBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error:', error));
    }

    function updateRowCalculation(rowIndex) {
    const plan = document.querySelector(`input[name="plan-${rowIndex}"]:checked`).value;
    const monthlyRate = document.querySelector(`input[name="monthly-rate-${rowIndex}"]`).value;
    
    // Get the rebate value from the corresponding column
    const row = document.querySelector(`#rebate-results-body tr:nth-child(${rowIndex})`);
    const rebate = row.querySelector(`td:nth-child(${plan === 'bronze' ? 2 : plan === 'silver' ? 3 : 4})`).innerText;
    
    // Calculate the annual cost
    const annualCost = (monthlyRate * 12) - parseFloat(rebate);
    // limit the decimal places to 2
    document.getElementById(`updated-calculation-${rowIndex}`).innerText = `Annual Cost: ${annualCost.toFixed(2)}`;
}

function addRow() {
    const tbody = document.getElementById('rebate-form-body');
    const rowCount = tbody.rows.length + 1;
    const newRow = document.createElement('tr');
    newRow.className = 'rebate-form-row';
    newRow.innerHTML = `
        <td>${rowCount}</td>
        <td>
            <input type="text" id="drug-name-${rowCount}" name="drug-name">
        </td>
        <td>
            <input type="checkbox" id="branded-${rowCount}" name="drug-type" value="branded" onclick="toggleCheckbox(this)">
            <label for="branded-${rowCount}">Branded</label>
            <input type="checkbox" id="generic-${rowCount}" name="drug-type" value="generic" onclick="toggleCheckbox(this)">
            <label for="generic-${rowCount}">Generic</label>
        </td>
        <td>
            <input type="number" id="fills-year-${rowCount}" name="fills-per-year" style="width: 4vw" required>
            <label for="fills-month-${rowCount}" class="hidden"></label>
        </td>
        <td>
            <button type="button" onclick="removeRow(this)">Remove</button>
        </td>
    `;
    tbody.appendChild(newRow);
}

function removeRow(button) {
    const row = button.closest('tr');
    row.remove();

    // Update row numbers
    const rows = document.querySelectorAll('#rebate-form-body tr');
    rows.forEach((row, index) => {
        row.querySelector('td:first-child').innerText = index + 1;
    });
}
</script>
</body>
</html>