<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home Health Care Rebate Calculator</title>
</head>
<body>
    <div class="logout-container">
        {{ user.first_name }} {{ user.last_name }}
        <form id="logout-form" class="logout-button-form" action="{% url 'Logout' %}"
              method="POST" hx-trigger="click" title="Sign Out">
            {% csrf_token %}
            <button type="submit" class="logout-button preload" title="Sign Out">
                <!-- Logout icon from hugeicons.com -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                     color="#000000" fill="none">
                    <path d="M11 3L10.3374 3.23384C7.75867 4.144 6.46928 4.59908 5.73464 5.63742C5 6.67576 5 8.0431 5 10.7778V13.2222C5 15.9569 5 17.3242 5.73464 18.3626C6.46928 19.4009 7.75867 19.856 10.3374 20.7662L11 21"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    <path d="M21 12L11 12M21 12C21 11.2998 19.0057 9.99153 18.5 9.5M21 12C21 12.7002 19.0057 14.0085 18.5 14.5"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                          stroke-linejoin="round"></path>
                </svg>
            </button>
        </form>
    </div>
    <h2 style="margin-top: 1px; margin-bottom: 1px;">Home Health Care Drug Fill Rebate</h2>
    <div class="rebate-container" style="margin-left: 1.5vw;">
        <form id="rebate-form" class="rebate-form" action="{% url 'RebateCalculator' %}" method="POST">
            {% csrf_token %}
            <div class="rebate-table-container" style="max-height: 32vh; overflow-y: auto;">
                <table class="rebate-table">
                    <thead>
                        <tr>
                            <th class="rebate-table-col">#</th>
                            <th class="rebate-table-col">Drug Name</th>
                            <th class="rebate-table-col">Drug Type</th>
                            <th class="rebate-table-col">Fills/Year</th>
                            <th class="rebate-table-col">Action</th>
                        </tr>
                    </thead>
                    <tbody id="rebate-form-body">
                        <tr class="rebate-form-row">
                            <td>1</td>
                            <td class="rebate-table-td">
                                <input type="text" id="drug-name-1" name="drug-name">
                            </td>
                            <td class="rebate-table-td">
                                <input type="checkbox" id="branded-1" name="drug-type" value="branded" onclick="toggleCheckbox(this)">
                                <label for="branded-1">Branded</label>
                                <input type="checkbox" id="generic-1" name="drug-type" value="generic" onclick="toggleCheckbox(this)">
                                <label for="generic-1">Generic</label>
                            </td>
                            <td class="rebate-table-td">
                                <input type="number" id="fills-year-1" name="fills-per-year" style="width: 4vw" required onchange="updateCalculations()">
                                <label for="fills-month-1" class="hidden"></label>
                            </td>
                            <td class="rebate-table-td">
                                <button type="button" onclick="removeRow(this)">Delete Row</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="rebate-form-button" onclick="addRow()">Add Row</button>
        </form>
    </div>
    <div class="results-container">
        <h2 style="margin: 0 0 0 0;">Rebate Results</h2>
        <table class="results-table">
            <thead>
                <tr>
                    <th class="results-table-col" style="width: 2%">Carrier</th>
                    <th class="results-table-col" style="color: oklch(59.79% 0.1389 58.23); width:2%">Bronze Rebate</th>
                    <th class="results-table-col" style="color: oklch(52.97% 0.0016 58.23); width:2%">Silver Rebate</th>
                    <th class="results-table-col" style="color: oklch(75.82% 0.149 73.18); width:2%">Gold Rebate</th>
                    <th class="results-table-col" style="width: 10%">Select Plan</th>
                    <th class="results-table-col" style="width: 2%">Monthly Rate</th>
                    <th class="results-table-col" style="width: 2%">Annualized Rate</th>
                    <th class="results-table-col" style="width: 2%">Post-Rebate Annualized Cost</th>
                </tr>
            </thead>
            <tbody id="rebate-results-body">
                {% if results %}
                    {% for result in results %}
                        <tr>
                            <td class="results-table-td">{{ result.carrier }}</td>
                            <td class="results-table-td" style="color: oklch(59.79% 0.1389 58.23)">{{ result.bronze }}</td>
                            <td class="results-table-td" style="color: oklch(75.82% 0.149 73.18)">{{ result.silver }}</td>
                            <td class="results-table-td" style="color: oklch(75.82% 0.149 73.18)">{{ result.gold }}</td>
                            <td class="results-table-td">
                                <input type="radio" name="plan-{{ forloop.counter }}" value="bronze" onchange="updateAnnualizedCost({{ forloop.counter }})"> Bronze
                                <input type="radio" name="plan-{{ forloop.counter }}" value="silver" onchange="updateAnnualizedCost({{ forloop.counter }})"> Silver
                                <input type="radio" name="plan-{{ forloop.counter }}" value="gold" onchange="updateAnnualizedCost({{ forloop.counter }})"> Gold
                            </td>
                            <td class="results-table-td">
                                <input type="number" name="monthly-rate-{{ forloop.counter }}" required onchange="updateAnnualizedCost({{ forloop.counter }})" style="width: 3vw; text-align: center" step="0.01" min="0">
                            </td>
                            <td id="annualCostPreRebate-{{ forloop.counter }}" class="results-table-td" style='background: oklch(37.91% 0 0 / 25%); color: oklch(67.86% 0.209 24.66)'></td>
                            <td id="updated-calculation-{{ forloop.counter }}" class="results-td" style='background: oklch(37.91% 0 0 / 25%)'></td>
                        </tr>
                    {% endfor %}
                {% else %}
                {% endif %}
                    <tr>
                        <td colspan="7">No results available</td>
                    </tr>
            </tbody>
        </table>
    </div>
<script>
    
    let selectedPlans = {};
    let monthlyRates = {};

    function updateCalculations() {
    const form = document.getElementById('rebate-form');
    const formData = new FormData(form);

    fetch('{% url "RebateCalculator" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        const resultsBody = document.getElementById('rebate-results-body');
        resultsBody.innerHTML = ''; // Clear existing results

        data.results.forEach((result, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="results-table-td">
                    <button type="button" onclick="openRateSheet('${result.carrier}')">${result.carrier}</button>
                </td>
                <td class="results-table-td">${result.bronze}</td>
                <td class="results-table-td">${result.silver}</td>
                <td class="results-table-td">${result.gold}</td>
                <td class="results-table-td">
                    <input type="radio" name="plan-${index + 1}" value="bronze" onchange="updateAnnualizedCost(${index + 1})"> Bronze
                    <input type="radio" name="plan-${index + 1}" value="silver" onchange="updateAnnualizedCost(${index + 1})"> Silver
                    <input type="radio" name="plan-${index + 1}" value="gold" onchange="updateAnnualizedCost(${index + 1})"> Gold
                </td>
                <td class="results-table-td">
                    <input type="number" name="monthly-rate-${index + 1}" required onchange="updateAnnualizedCost(${index + 1})" style="width: 2.5vw;" step="0.01" min="0">
                </td>
                <td id="annualCostPreRebate-${index + 1}" class="results-table-td" style='background: oklch(37.91% 0 0 / 25%); color: oklch(67.86% 0.209 24.66)'></td>
                <td id="updated-calculation-${index + 1}" class="results-table-td" style='background: oklch(37.91% 0 0 / 25%)'></td>
            `;
            resultsBody.appendChild(row);
            
            // if there selectedPlans is not empty, we want to set the selected plan and monthly rate
            console.log('monthlyRates', monthlyRates);
           
            if(selectedPlans[index] || monthlyRates[index]) {
                row.querySelector(`input[name="plan-${index + 1}"][value="${selectedPlans[index]}"]`).checked = true;
                row.querySelector(`input[name="monthly-rate-${index + 1}"]`).value = monthlyRates[index];
                updateAnnualizedCost(index + 1);
            }
        });
        document.querySelector('.results-container').style.display = 'block';
    })
    .catch(error => console.error('Error:', error));
    }

    function updateAnnualizedCost(rowIndex) {
        const monthlyRate = document.querySelector(`input[name="monthly-rate-${rowIndex}"]`).value;
        document.getElementById(`annualCostPreRebate-${rowIndex}`).innerText = `\$${(monthlyRate * 12).toFixed(2)}`;
    const plan = document.querySelector(`input[name="plan-${rowIndex}"]:checked`).value;
    
    // Store the selected plan and monthly rate
    selectedPlans[rowIndex - 1] = plan;
    monthlyRates[rowIndex - 1] = monthlyRate;
        

        // Get the rebate value from the corresponding column
    const row = document.querySelector(`#rebate-results-body tr:nth-child(${rowIndex})`);
    const rebate = row.querySelector(`td:nth-child(${plan === 'bronze' ? 2 : plan === 'silver' ? 3 : 4})`).innerText;

    // Calculate the annual cost
    const annualCost = (monthlyRate * 12) - parseFloat(rebate);
    // limit the decimal places to 2
    document.getElementById(`updated-calculation-${rowIndex}`).innerText = `\$:${annualCost.toFixed(2)}`;
    // if the annual cost is negative, we want to show it in green, otherwise red. also we want to make a dark transparent background to make it more visible
    document.getElementById(`updated-calculation-${rowIndex}`).style.color = annualCost < 0 ? 'oklch(58.83% 0.1654 149.02)' : 'oklch(67.86% 0.209 24.66)';

}

function addRow() {
    const lastRow = document.querySelector('#rebate-form-body tr:last-child');
    const drugType = lastRow.querySelector('input[name="drug-type"]:checked');
    const fillsPerYear = lastRow.querySelector('input[name="fills-per-year"]').value;

    if(!drugType && !fillsPerYear) {
        alert('Please select a drug type and enter the number of fills per year for the last row');
        return;
    }
    else if (!drugType) {
        alert('Please select a drug type for the last row');
        return;
    }
    else if (!fillsPerYear) {
        alert('Please enter the number of fills per year for the last row');
        return;
    }

    const tbody = document.getElementById('rebate-form-body');
    const rowCount = tbody.rows.length + 1;
    const newRow = document.createElement('tr');
    newRow.className = 'rebate-form-row';
    newRow.innerHTML = `
        <td class="rebate-table-td">${rowCount}</td>
        <td>
            <input type="text" id="drug-name-${rowCount}" name="drug-name">
        </td>
        <td class="rebate-table-td">
            <input type="checkbox" id="branded-${rowCount}" name="drug-type" value="branded" onclick="toggleCheckbox(this)">
            <label for="branded-${rowCount}">Branded</label>
            <input type="checkbox" id="generic-${rowCount}" name="drug-type" value="generic" onclick="toggleCheckbox(this)">
            <label for="generic-${rowCount}">Generic</label>
        </td>
        <td class="rebate-table-td">
            <input type="number" id="fills-year-${rowCount}" name="fills-per-year" style="width: 4vw" required onchange=updateCalculations()>
            <label for="fills-month-${rowCount}" class="hidden"></label>
        </td>
        <td class="rebate-table-td">
            <button type="button" onclick="removeRow(this)">Delete Row</button>
        </td>
    `;
    tbody.appendChild(newRow);
    updateCalculations()
}

function removeRow(button) {
    // Make sure we don't delete the last row
    if (document.querySelectorAll('#rebate-form-body tr').length === 1) {
        return;
    }
    const row = button.closest('tr');
    row.remove();

    // Update row numbers
    const rows = document.querySelectorAll('#rebate-form-body tr');
    rows.forEach((row, index) => {
        row.querySelector('td:first-child').innerText = index + 1;
    });
    updateCalculations()
}

function toggleCheckbox(checkbox) {
    const row = checkbox.closest('tr');
    const checkboxes = row.querySelectorAll(`input[name="${checkbox.name}"]`);
    checkboxes.forEach((cb) => {
        if (cb !== checkbox) {
            cb.checked = false;
        }
    });
    updateCalculations()
}

function openRateSheet(carrier) {
    const rateSheetUrls = {
        'GTL': '/view_pdf/1422/',
        'United Life': '/view_pdf/51',
        'Heartland National': '/view_pdf/514',
        'Standard Life': '/view_pdf/3129'
    };
    const url = rateSheetUrls[carrier];
    if (url) {
        openModal(url);
    } else {
        alert('Rate sheet not available for ' + carrier);
    }
}
</script>
</body>
</html>