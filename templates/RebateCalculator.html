<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home Health Care Rebate Calculator</title>
</head>
<body>
    <div class="logout-container">
        {{ user.first_name }} {{ user.last_name }}
        <form id="logout-form" class="logout-button-form" action="{% url 'Logout' %}"
              method="POST" hx-trigger="click" title="Sign Out">
            {% csrf_token %}
            <button type="submit" class="logout-button preload" title="Sign Out">
                <!-- Logout icon from hugeicons.com -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                     color="#000000" fill="none">
                    <path d="M11 3L10.3374 3.23384C7.75867 4.144 6.46928 4.59908 5.73464 5.63742C5 6.67576 5 8.0431 5 10.7778V13.2222C5 15.9569 5 17.3242 5.73464 18.3626C6.46928 19.4009 7.75867 19.856 10.3374 20.7662L11 21"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    <path d="M21 12L11 12M21 12C21 11.2998 19.0057 9.99153 18.5 9.5M21 12C21 12.7002 19.0057 14.0085 18.5 14.5"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                          stroke-linejoin="round"></path>
                </svg>
            </button>
        </form>
    </div>
    <h2 style="margin-top: 1px; margin-bottom: 1px;">Home Health Care Drug Fill Rebate</h2>
    <div class="rebate-container">
        <form id="rebate-form" class="rebate-form" action="{% url 'RebateCalculator' %}" method="POST">
            {% csrf_token %}
            <div class="rebate-table-container" style="max-height: 25vh; overflow-y: auto">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Drug Name</th>
                            <th>Drug Type</th>
                            <th>Fills/Year</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="rebate-form-body">
                        <tr class="rebate-form-row">
                            <td>1</td>
                            <td>
                                <input type="text" id="drug-name-1" name="drug-name">
                            </td>
                            <td>
                                <input type="checkbox" id="branded-1" name="drug-type" value="branded" onclick="toggleCheckbox(this)">
                                <label for="branded-1">Branded</label>
                                <input type="checkbox" id="generic-1" name="drug-type" value="generic" onclick="toggleCheckbox(this)">
                                <label for="generic-1">Generic</label>
                            </td>
                            <td>
                                <input type="number" id="fills-year-1" name="fills-per-year" style="width: 4vw" required>
                                <label for="fills-month-1" class="hidden"></label>
                            </td>
                            <td>
                                <button type="button" onclick="removeRow(this)">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="rebate-form-button" onclick="addRow()">Add Row</button>
            <button type="submit" class="rebate-form-button preload">Calculate Rebate</button>
        </form>
    </div>
    <div class="results-container" style="overflow-y: auto">
        <h2 style="margin: 0 0 0 0;">Rebate Results</h2>
        <table>
            <thead>
                <tr>
                    <th>Carrier</th>
                    <th>Bronze</th>
                    <th>Silver</th>
                    <th>Gold</th>
                </tr>
            </thead>
            <tbody id="rebate-results-body">
                {% if results %}
                    {% for result in results %}
                        <tr>
                            <td>{{ result.carrier }}</td>
                            <td>{{ result.bronze }}</td>
                            <td>{{ result.silver }}</td>
                            <td>{{ result.gold }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                {% endif %}
                    <tr>
                        <td colspan="4">No results available</td>
                    </tr>
            </tbody>
        </table>
    </div>
<script>
    let rowCounter = 1; // Initialize the row counter

    function addRow() {
        rowCounter++; // Increment the row counter
        const tbody = document.getElementById('rebate-form-body');
        const newRow = document.createElement('tr');
        newRow.className = 'rebate-form-row';
        newRow.innerHTML = `
            <td>${rowCounter}</td>
            <td>
                <input type="text" id="drug-name-${rowCounter}" name="drug-name">
            </td>
            <td>
                <input type="checkbox" id="branded-${rowCounter}" name="drug-type" value="branded" onclick="toggleCheckbox(this)">
                <label for="branded-${rowCounter}">Branded</label>
                <input type="checkbox" id="generic-${rowCounter}" name="drug-type" value="generic" onclick="toggleCheckbox(this)">
                <label for="generic-${rowCounter}">Generic</label>
            </td>
            <td>
                <input type="number" id="fills-year-${rowCounter}" name="fills-per-year" style="width: 4vw" required>
                <label for="fills-month-${rowCounter}" class="visually-hidden"></label>
            </td>
            <td>
                <button type="button" onclick="removeRow(this)">Remove</button>
            </td>
        `;
        tbody.appendChild(newRow);
        updateCalculations(); // Update calculations after adding a new row
    }

    function removeRow(button) {
        const row = button.parentNode.parentNode;
        row.parentNode.removeChild(row);
        renumberRows();
        updateCalculations(); // Update calculations after removing a row
    }

    function renumberRows() {
        const rows = document.querySelectorAll('.rebate-form-row');
        rows.forEach((row, index) => {
            row.querySelector('td').innerText = index + 1;
        });
        rowCounter = rows.length;
    }

    function toggleCheckbox(checkbox) {
        const checkboxes = checkbox.parentNode.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb !== checkbox) {
                cb.checked = false;
            }
        });
    }

    document.getElementById('rebate-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission
        updateCalculations(); // Update calculations on form submission
    });

    function updateCalculations() {
        const form = document.getElementById('rebate-form');
        const formData = new FormData(form);

        fetch('{% url "RebateCalculator" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            const resultsBody = document.getElementById('rebate-results-body');
            resultsBody.innerHTML = ''; // Clear existing results

            data.results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.carrier}</td>
                    <td>${result.bronze}</td>
                    <td>${result.silver}</td>
                    <td>${result.gold}</td>
                `;
                resultsBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error:', error));
    }
</script>
</html>